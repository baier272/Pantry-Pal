# å¸¦æ•°é‡çš„æ–°é²œæ˜“è€—é£Ÿæ

# p_name æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
# freshfood[p_name] æ˜¯ä¸€ä¸ªå­å­—å…¸

#åŠ è½½
import pickle
import os

# å­—æ®µåˆå§‹å€¼
changes = {}


#å®šä¹‰åŠŸèƒ½

#ä¿å­˜å˜é‡çš„åŒåæ•°æ®æ–‡ä»¶
def saveit(vir,name):
    filename = name + ".data"
    f = open(filename, 'wb')
    pickle.dump(vir, f)
    f.close()
    print("\nâœ… å·²å‚¨å­˜åˆ° "+name+".data")


def initialize(valuename):
    filename = valuename + ".data"
    f = open(filename, "wb")
    if valuename == "freshfood":
        freshfood = {}
        #freshfood = {'vegetables': {'é’æ¤’': 3, 'è èœ': 1, 'ç”Ÿèœ': 1}, 'protein': {'è±†è…': 2, 'è±†è±‰é²®é±¼': 1}, 'carbon': {'åœŸè±†': 4, 'çº¢è–¯': 5}, 'complex': {'é¸¿ç¦§è‡': 2, 'é‡‘é’ˆè‡': 1}, 'fruits': {'é¦™è•‰': 3,  'æ©™å­': 1}}
        fb = open("freshfood.data", 'wb')
        pickle.dump(freshfood, fb)  # å­˜å…¥æ€»å­—å…¸æ–‡ä»¶
        print("\nâœ… å·²åˆå§‹åŒ– freshfood.data")
    elif valuename == "danger":
        danger = {}
        #danger = {"é¦™è•‰":2,"è±†è…":1}
        fb = open("danger.data", 'wb')
        pickle.dump(danger, fb)  # å­˜å…¥å¿«åˆ°æœŸé£Ÿæ
        print("\nâœ… å·²åˆå§‹åŒ– danger.data")
    fb.close()


#è¯»å–æ•°æ®æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆä¸´æ—¶å˜é‡ tempdata
def readdata(valuename):
    filename =  valuename + ".data"
    if os.path.exists(filename):
        f = open(filename, "rb")
        tempdata = pickle.load(f)
        return tempdata
    else:
        print("\nâ—ï¸ no such file:", filename)
        initialize(valuename)
        f = open(filename, "rb")
        tempdata = pickle.load(f)
        return tempdata


#æ‰“å°å­—å…¸(old)
# def print_dict(d):
#     print("----------------------------\nä»¥ä¸‹æ˜¯",d, "çš„åˆ—è¡¨\n----------------------------")
#     for k,v in sorted(freshfood[d].items()):
#         if v > 0:
#             #print("ğŸ”˜", k,"\t",v)
#             tplt = "{0:<2}{1:{3}<8}\t{2:<3}"
#             print(tplt.format("ğŸ”˜", k, str(v), chr(12288)))
#         else :
#             tplt = "{0:<2}{1:{3}<8}\t{2:<3}"
#             print(tplt.format("ğŸš«", k, str(v), chr(12288)))
#     return d


#æ‰“å°å­—å…¸(new)
def print_dict(p_name):
    print("-----------------------------------\nä»¥ä¸‹æ˜¯", p_name, "çš„åˆ—è¡¨\n-----------------------------------")
    newlist = list()
    for food, count in freshfood[p_name].items():
        newlist.append((count, food))
    newlist.sort(reverse=True)
    for count, food in newlist:
        if count == 0:
            tplt = "{0:<2}{1:{3}<8}\t{2:<3}"
            print(tplt.format("ğŸš«", food, str(count), chr(12288)))
        elif count < 99:
            tplt = "{0:<2}{1:{3}<8}\t{2:<3}"
            print(tplt.format("ğŸ”˜", food, str(count), chr(12288)))
        else:
            tplt = "{0:<2}{1:{3}<8}\t{2:<3}"
            print(tplt.format("ãƒ»", food, str(count), chr(12288)))


#å±•ç¤ºå¸¦åºå·çš„å­—å…¸keyï¼Œå¹¶ç”Ÿæˆä¸´æ—¶æ–°åˆ—è¡¨tempix
def dicttols(ordir):
    tempix = list()
    for ls in ordir.keys():
        tempix.append(ls)
        print(tempix.index(ls) + 1, ls)
    return tempix

#å±•ç¤ºå¸¦åºå·çš„å­—å…¸keyï¼Œå¹¶ç”Ÿæˆä¸´æ—¶æ–°åˆ—è¡¨æ’åºåçš„tempix
# def dicttols2(ordir):
#     tempix = list()
#     st=list()
#     for k,v in ordir.items():
#         st.append((v,k))
#     st.sort(reverse=True)
#     # print(st)
#     for ls in st:
#         tempix.append(ls[1])
#         print(tempix.index(ls[1]) + 1, ls[1],ls[0])
#     return tempix

#å±•ç¤ºå¸¦åºå·çš„å­—å…¸keyï¼Œå¹¶ç”Ÿæˆä¸´æ—¶æ–°åˆ—è¡¨æ’åºåçš„tempixï¼Œå‡çº§å¸¦å›¾æ ‡
def dicttols3(ordir):
    tempix = list()
    st = list()
    for k, v in ordir.items():
        st.append((v, k))
    st.sort(reverse=True)
    #print(st)
    for ls in st:
        tempix.append(ls[1])
        if ls[0] == 0:
            tplt = "{0:<2}{1:<4}{2:{4}<8}\t{3:<3}"
            print(tplt.format("ğŸš«", str(tempix.index(ls[1]) + 1), ls[1], str(ls[0]), chr(12288)))
        else:
            tplt = "{0:<2}{1:<4}{2:{4}<8}\t{3:<3}"
            print(tplt.format("ğŸ”˜", str(tempix.index(ls[1]) + 1), ls[1], str(ls[0]), chr(12288)))
    return tempix

#ä»æ–°ç”Ÿæˆçš„åˆ—è¡¨ä¸­ï¼Œç”¨åç§°æˆ–åºå·é€‰æ‹©å‡ºkeyåç§°ï¼šname
def askch(tempix):
    ch = input(" \nè¯·é€‰æ‹©é¡¹ç›®æˆ–è¾“å…¥ï¼ˆå›è½¦é€€å‡ºï¼‰ï¼š")
    if len(ch)==0:
        print("æœªè¾“å…¥")
    try:
        name = tempix[int(ch) - 1]
    except:
        name = ch
    return name

#ç¡®è®¤åŠŸèƒ½ï¼ˆç¡®è®¤åç›´æ¥ä¿å­˜æ–‡ä»¶ï¼‰
def check(p_name,ck,food,wehave_before,wehave_after):
    if len(ck) <1:
        freshfood[p_name][food] = wehave_after
        print("âœ”ï¸ å·²å®Œæˆä¿®æ”¹")
        changes[food] = changes.get(food,0) + wehave_after - wehave_before
        saveit(freshfood,"freshfood")
    elif ck == "n":
        freshfood[p_name][food] = wehave_before
        print("ğŸŒ€ï¸ å·²æ’¤é”€")
    elif ck == "d":
        dekey(freshfood[p_name], food)
        print("âœ”ï¸âœ”ï¸ å·²åˆ é™¤è¯¥é£Ÿæ")
        changes[food] = "åˆ é™¤"
        saveit(freshfood,"freshfood")
    else:
        freshfood[p_name][food] = wehave_before
        print("ğŸŒ€ï¸ å·²æ’¤é”€")
    return ck


#å‘åˆ†ç±»å­—å…¸ä¸­æ·»åŠ é£Ÿæ,å¹¶ä¿å­˜
def addfood(p_name,food,n):
    wehave_before = freshfood[p_name].get(food, 0)
    print("ä¹‹å‰:",food,wehave_before)
    wehave_after = wehave_before + n
    print("ğŸ’¬ ğŸŸ¢ å³å°†æ·»åŠ ï¼š",food,n)
    ck = input("ğŸ”” ç¡®å®šä¿®æ”¹ï¼Ÿï¼ˆå›è½¦:æ˜¯ï¼›n:å¦ï¼›d:åˆ é™¤é£Ÿæ):")
    check(p_name,ck,food,wehave_before,wehave_after)
    if ck == "1":
        print("ğŸ’¬ æ·»åŠ åï¼š",food,freshfood[p_name][food])
    return freshfood

##å‘åˆ†ç±»å­—å…¸ä¸­å‡å°‘é£Ÿæ,å¹¶ä¿å­˜
def redufood(p_name,food,n):
    wehave_before = freshfood[p_name].get(food, 0)
    print("ä¹‹å‰ï¼š", food,wehave_before)
    wehave_after = wehave_before - n
    if wehave_after < 0:
        wehave_after = 0
    print("ğŸ’¬ ğŸ”» å³å°†å‡å°‘ï¼š", food, n)
    ck = input("ğŸ”” ç¡®å®šä¿®æ”¹ï¼Ÿï¼ˆå›è½¦:æ˜¯ï¼›n:å¦ï¼›d:åˆ é™¤é£Ÿæ):")
    check(p_name,ck,food, wehave_before, wehave_after)
    if ck == "1":
        print("ğŸ’¬ å‡å°‘åï¼š",food,freshfood[p_name][food])
    return freshfood

#åˆ é™¤å­—å…¸ä¸­çš„keyåŠŸèƒ½
def dekey(d,key):
    if key in d:
        del d[key]
        return d

# ç”¨å­—å…¸ç”Ÿæˆå…¨éƒ¨å…ƒç´ (æœ‰åº“å­˜çš„ï¼‰çš„å¤§å­—å…¸:allfood
def getallitems(var):
    allfood = {} #æ–°å»ºä¸´æ—¶é£Ÿæåˆ—è¡¨
    for cate,foods in var.items():
        for k,v in foods.items():
            if v > 0 :
                allfood[k] = v
            else:continue
    return allfood

#æœ¬æ¬¡ä¿®æ”¹æƒ…å†µ
def thistime():
    print("\n_____æœ¬æ¬¡ä¿®æ”¹æƒ…å†µ_____")
    for food,count in changes.items():
        print(food,count)


print("\n\nğŸ§… ğŸ¥¬ ğŸ¥• ğŸ… ğŸ¥š ğŸ— ğŸ¥© æˆ‘æ˜¯æ–°é²œé£Ÿæç²¾ ğŸ§… ğŸ¥¬ ğŸ¥• ğŸ… ğŸ¥š ğŸ— ğŸ¥© ")
#è¯»freshfoodæ–‡ä»¶

freshfood = readdata("freshfood")

#è¯»å–dangeræ•°æ®
danger = readdata("danger")

# ç”Ÿæˆå…¨éƒ¨é£Ÿæå¤§å­—å…¸
allfood = getallitems(freshfood)

#åˆ é™¤å·²ç»æ²¡æœ‰çš„å±é™©é£Ÿå“

for food in list(danger.keys()):
    if food not in allfood or allfood[food]==0:
        dekey(danger,food)
        print("ğŸ—‘ å·²è‡ªåŠ¨åˆ é™¤æ²¡æœ‰çš„å±é™©é£Ÿå“ï¼š",food)
        print("\nğŸ’¬ å·²è°ƒæ•´å±é™©é£Ÿæ")
        saveit(danger,"danger")

#è°ƒæ•´å±é™©é£Ÿææ•°é‡
for food,count in list(danger.items()):
    danger[food]=allfood[food]
print("\nğŸ’¬ å·²è°ƒæ•´å±é™©é£Ÿæ")
saveit(danger,"danger")
print("\n________________________________________________________________________")

while True:
    # è¯»freshfoodæ–‡ä»¶
    freshfood = readdata("freshfood")
    print("\n 1:ğŸ“¥ æ·»åŠ ; 2:ğŸ—‘ å‡å°‘; 3:ğŸ” æŸ¥è¯¢; 4:âš ï¸ å±é™©é£Ÿæ; 5ï¼šğŸ‘‹ğŸ¼ é€€å‡º")
    ch = input("\nè¯·è¾“å…¥æŒ‡ä»¤:")
    try:
        ch = int(ch)
    except:
        print("â—ï¸ è¯·è¾“å…¥æ•°å­—åºå·")
        continue
    if ch == 1:
        print("\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå¼€å§‹é€‰æ‹©ç±»åˆ«")
        tempix = dicttols(freshfood) #å±•ç¤ºå¤§å­—å…¸åˆ—è¡¨
        p_name = askch(tempix) #é€‰æ‹©ç±»åˆ«åç§°
        if len(p_name) == 0 :
            print("â—ï¸ æœªé€‰æ‹©ç±»åˆ«ï¼Œä¸­æ–­ã€‚")
            continue
        freshfood[p_name] = freshfood.get(p_name,dict()) #å¦‚æœæ²¡æœ‰åˆ—è¡¨å°±å»ºç«‹ä¸€ä¸ªåˆ†ç±»
        while True:
            tempix = dicttols3(freshfood[p_name])  # å±•ç¤ºå°ç±»åˆ«å†…ç‰©å“åˆ—è¡¨
            print("â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n ğŸŸ¢ æ·»åŠ é£Ÿæ")
            food = askch(tempix)  # é€‰æ‹©å¹¶ç”Ÿæˆé£Ÿæåç§°
            if len(food) == 0:
                print("â—ï¸ æœªè¾“å…¥é£Ÿæåç§°ï¼Œè·³å‡ºã€‚")
                break
            if food in freshfood[p_name]:
                print("ç°æœ‰:", food, freshfood[p_name][food])
            n = input("è¾“å…¥æ·»åŠ  "+ food+" çš„æ•°é‡ï¼š")  # è¾“å…¥å¢åŠ æ•°é‡
            try:
                n = int(n)
                freshfood = addfood(p_name, food, n)
            except:
                print("æœªè¾“å…¥æ•°é‡ï¼Œä¸­æ–­ã€‚")
                break
    elif ch == 2:
        print("\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nå¼€å§‹é€‰æ‹©ç±»åˆ«")
        tempix = dicttols(freshfood) #å±•ç¤ºå¤§å­—å…¸åˆ—è¡¨
        p_name = askch(tempix) #é€‰æ‹©ç±»åˆ«åç§°
        if p_name not in freshfood:
            print("â—ï¸ æ— æ­¤åˆ—è¡¨")
            continue
        while True:
            # å±•ç¤ºå°ç±»åˆ«å†…ç‰©å“åˆ—è¡¨
            tempix = dicttols3(freshfood[p_name])
            # tempix = list()
            # for ls in freshfood[p_name].keys():
            #     tempix.append(ls)
            #     if freshfood[p_name][ls] == 0:
            #         tplt = "{0:<2}{1:<4}{2:{4}<8}\t{3:<3}"
            #         print(tplt.format("ğŸš«", str(tempix.index(ls)+1),ls, str(freshfood[p_name][ls]), chr(12288)))
            #     else:
            #         tplt = "{0:<2}{1:<4}{2:{4}<8}\t{3:<3}"
            #         print(tplt.format("ğŸ”˜", str(tempix.index(ls)+1),ls, str(freshfood[p_name][ls]), chr(12288)))
            print("â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n ğŸ”» å¼€å§‹å‡å°‘é£Ÿæ")
            food = askch(tempix)  # é€‰æ‹©å¹¶ç”Ÿæˆé£Ÿæåç§°
            if len(food) == 0:
                print("â—ï¸ æœªè¾“å…¥ï¼Œä¸­æ–­")
                break
            print("ç°æœ‰:", food, freshfood[p_name][food])
            n = input("è¾“å…¥ç§»é™¤"+ food+"çš„æ•°é‡(â ï¼šç§»é™¤å…¨éƒ¨ï¼‰ï¼š ")  # è¾“å…¥ç§»é™¤æ•°é‡
            if len(n) == 0 :
                n = freshfood[p_name][food]
            try:
                n = int(n)
            except:
                print("â—ï¸ æœªè¾“å…¥æ•°é‡ï¼Œä¸­æ–­ã€‚")
                break
            freshfood = redufood(p_name,food,n)
    elif ch == 3:
        ch = input("è¯·è¾“å…¥æŒ‡ä»¤ï¼ˆå›è½¦ï¼šæŸ¥çœ‹å…¨éƒ¨ï¼›å…¶ä»–ä»»æ„é”®ï¼šåˆ†ç±»æŸ¥çœ‹ï¼‰ï¼š")
        if len(ch) == 0 :
            for p_name in freshfood.keys():
                print_dict(p_name)
        else:
            while True:
                tempix = dicttols(freshfood)
                p_name = askch(tempix)  # é€‰æ‹©ç±»åˆ«åç§°
                if p_name in freshfood.keys():
                    print_dict(p_name)
                else:
                    print("â—ï¸ æ— æ­¤åˆ—è¡¨ï¼Œä¸­æ–­")
                    break
    elif ch == 4:
        #ç”Ÿæˆæœ€æ–°å…¨éƒ¨é£Ÿæå¤§å­—å…¸
        allfood = getallitems(freshfood)
        #å±•ç¤º
        print("\nâš ï¸ å±é™©é£Ÿæï¼š\n______________")
        newlist = list()
        for food, count in danger.items():
            newlist.append((count, food))
        newlist.sort(reverse=True)
        for count, food in newlist:
            if count < 99:
                tplt = "{0:<2}{1:{3}<8}\t{2:<3}"
                print(tplt.format("ğŸ”˜", food, str(count), chr(12288)))
            else:
                tplt = "{0:<2}{1:{3}<8}\t{2:<3}"
                print(tplt.format("ãƒ»", food, str(count), chr(12288)))
        # for (food, count) in danger.items():
        #     print(food, count)
        ch = input("______________\nè¯·è¾“å…¥æŒ‡ä»¤ï¼ˆ1ï¼šæ·»åŠ å±é™©é£Ÿæï¼›2ï¼šåˆ é™¤å±é™©é£Ÿæï¼‰ï¼š")
        try:
            ch = int(ch)
        except:
            print("â—ï¸ æŒ‡ä»¤é”™è¯¯ï¼Œè¯·è¾“å…¥æ•°å­—åºå·")
            continue
        if ch == 1:  #æ‰§è¡Œæ·»åŠ é£Ÿæå¾ªç¯
            while True:
                print("\nå¼€å§‹æ·»åŠ å±é™©é£Ÿæ\n______________")
                tempix = dicttols3(allfood)
                food = askch(tempix)
                if len(food) == 0:
                    print("â—ï¸ æœªè¾“å…¥ï¼Œä¸­æ–­")
                    break
                else:
                    if food not in allfood.keys() or allfood[food] == 0:
                        print("â—ï¸è¯¥é£Ÿæä¸åœ¨ç°æœ‰é£Ÿæåˆ—è¡¨ä¸­ï¼Œæˆ–å·²ç”¨å®Œï¼")
                        continue
                    if food in allfood.keys():
                        danger[food] = allfood[food]
                        print("âœ”ï¸  å·²æ·»åŠ å±é™©é£Ÿå“ï¼š", food)
                        saveit(danger, "danger")  # å‚¨å­˜æ–‡ä»¶

        elif ch == 2:         #è¿›å…¥åˆ é™¤é£Ÿæå¾ªç¯
            while True:
                print("\nå¼€å§‹åˆ é™¤å±é™©é£Ÿæ\n______________\nç°æœ‰å±é™©é£Ÿæ\n______________")
                tempix = dicttols3(danger)
                food = askch(tempix)
                if food in allfood.keys():
                    dekey(danger, food)
                    print("âœ”ï¸  å·²åˆ é™¤å±é™©é£Ÿå“ï¼š", food)
                    saveit(danger, "danger")  # å‚¨å­˜æ–‡ä»¶
                else:
                    print("â—ï¸ æ— æ­¤é£Ÿæï¼Œä¸­æ–­")
                    break
        else:
            print("â—ï¸ æŒ‡ä»¤é”™è¯¯ï¼Œè¯·è¾“å…¥æŒ‡ä»¤åºå·ï¼Œä¸­æ–­")
            continue
    elif ch == 5:
        thistime()
        print("Bye")
        quit()
    else:
        print("â—ï¸ è¯·è¾“å…¥åºå·")
        continue
